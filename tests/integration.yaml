load_pattern:
  - !linear
      to: 100%
      over: 5s
config:
  client:
    headers:
      test: 123
      float: 1.23
loggers:
  l:
    limit: 2
    to: !stderr
  timeLogger:
    to: !file 'test-epoch-${x:epoch("ms")}.json'
vars:
  b: "foo"
  e2: ["foo", "foo", "foo"]
  port: "${e:PORT}"
  int: 12345
  float: 1.2345 # Make sure these can be parsed
providers:
  a:
    !range
  c:
    !list
      - 123
      - 456
  d:
    !response
  f:
    !file
      path: integration.data
      repeat: true
endpoints:
  - method: POST
    declare:
      e: !c
        collects:
          - take: 3
            from: '${v:b}'
            as: _b
        then: ${p:_b}
    url: http://localhost:${v:port}/
    body: !str '{"a": ${p:a}, "b": "${v:b}", "c": ${p:c}, "e": ${p:e}, "e2": ${v:e2}, "f": "${p:f}"}'
    peak_load: 1.1hps
    headers:
      Content-Type: application/json
    logs:
      l:
        select:
          each:
            - 'response.body.b == "foo"'
            - 'val_eq(response.body.e, response.body.e2)'
            - 'request.headers.test == "123"'
            - 'parseInt(request.headers.test) + 1 == 124'
            - 'parseInt(request.headers.float) == 1'
            - 'parseFloat(request.headers.float) == 1.23'
            - 'parseInt(response.body.b) == null'
            - 'response.body.a == 0'
            - 'response.body.c == 123'
            - 'response.body.f == "line1"'
            - 'response.body.a == 1'
            - 'response.body.c == 456'
            - 'response.body.f == "line2"'
          all: >-
            (response.body.b == "foo"
              && val_eq(response.body.e, response.body.e2)
              && request.headers.test == "123"
              && parseInt(request.headers.test) + 1 == 124
              && parseInt(request.headers.float) == 1
              && parseFloat(request.headers.float) == 1.23
              && parseInt(response.body.b) == null
            )
            &&
            (
              (response.body.a == 0
                && response.body.c == 123
                && response.body.f == "line1")
              ||
              (response.body.a == 1
                && response.body.c == 456
                && response.body.f == "line2")
            )
